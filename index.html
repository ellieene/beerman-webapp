<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Beerman –ó–∞–∫–∞–∑—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
      /* --- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ (–∑–µ–ª—ë–Ω–∞—è) --- */
      .search-btn {
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #28a745; /* ‚úÖ –∑–µ–ª—ë–Ω–∞—è */
          color: white;
          border: none;
          border-radius: 50%;
          width: 60px;
          height: 60px;
          font-size: 26px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
          cursor: pointer;
          z-index: 999;
          transition: background 0.2s ease;
      }
      .search-btn:hover {
          background: #218838;
      }

      /* --- –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ --- */
      #search-box {
          position: fixed;
          bottom: 90px;
          right: 20px;
          background: white;
          padding: 10px;
          border-radius: 12px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.2);
          display: none;
          width: 260px;
      }

      #search-input {
          width: 100%;
          padding: 8px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 6px;
      }

      .search-results {
          max-height: 200px;
          overflow-y: auto;
          margin-top: 10px;
      }

      .search-results div {
          padding: 5px 8px;
          border-bottom: 1px solid #eee;
          cursor: pointer;
      }
      .search-results div:hover {
          background: #f0f0f0;
      }

      /* --- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ --- */
      @keyframes darkHighlight {
          0% { background-color: #444; color: white; }
          80% { background-color: #444; color: white; }
          100% { background-color: white; color: black; }
      }

      .highlighted {
          animation: darkHighlight 2s ease;
      }
    body { font-family: Arial; background: #f5f5f5; margin: 0; padding: 10px; }
    #beerman { color:#e74c3c; text-align:center; font-size: 30px; margin-bottom: 10px; }
    h1 { text-align: center; font-size: 24px; }
    h2 { margin-top: 20px; font-size: 20px; }
    .product { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 10px; margin: 5px 0; border-radius: 8px; font-size: 18px; }
    .product span.name { flex: 1 1 auto; min-width: 120px; margin-right: 10px; word-break: break-word; }
    .btns { display: flex; align-items: center; gap: 10px; flex: 0 0 auto; }
    .btns button { width: 45px; height: 45px; font-size: 22px; border-radius: 8px; border: none; background: #007bff; color: white; cursor:pointer; }
    .btns span { min-width: 30px; text-align: center; font-size: 18px; display: inline-block; }
    .send-btn { display: block; width: 100%; padding: 15px 0; font-size: 20px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 30px; cursor:pointer; }
    
    /* –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å */
    #admin-panel { display:none; margin-top:30px; padding:20px; background:#ffffff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    #admin-panel h2 { color:#e74c3c; text-align:center; font-size:26px; margin-bottom:20px; }
    #admin-panel input, #admin-panel select { padding:5px; margin-left:5px; border-radius:6px; border:1px solid #ccc; }
    #admin-panel button { cursor:pointer; border:none; border-radius:6px; padding:5px 10px; }
    .add-cat-btn { background:#27ae60; color:white; }
    .add-prod-btn { background:#3498db; color:white; }
    .remove-btn { background:#dc3545; color:white; margin-left:10px; }
    #admin-products div { background:#f8f9fa; padding:5px 10px; border-radius:6px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <h2 id="beerman">BEERMAN</h2>
  <div id="catalog"></div>
  <!-- üîç –ü–æ–∏—Å–∫ -->
  <div id="search-box">
      <input id="search-input" type="text" placeholder="–ü–æ–∏—Å–∫...">
      <div class="search-results"></div>
  </div>
  <button class="search-btn" onclick="toggleSearch()">üîç</button>
  <button class="send-btn" onclick="sendOrder()">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>

  <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
  <div id="admin-panel">
      <h2>üõ†Ô∏è BEERMAN ‚ö°</h2>

      <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
        <label style="flex:1;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:
          <select id="admin-category"></select>
        </label>
        <input type="text" id="new-category" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="flex:1;">
        <button onclick="addCategory()" class="add-cat-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
        <input type="text" id="admin-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" style="flex:2;">
        <select id="admin-unit" style="flex:1;">
          <option value="—à—Ç">—à—Ç</option>
          <option value="–∫–≥">–∫–≥</option>
          <option value="–ª">–ª</option>
        </select>
        <button onclick="addProduct()" class="add-prod-btn">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <h3 style="color:#2c3e50; font-size:20px; margin-bottom:10px;">–¢–æ–≤–∞—Ä—ã üìù</h3>
      <div id="admin-products"></div>
  </div>

<script>
let order = {};
let catalogData = {};
let locked = {};
const productStep = {
  "–ò–∫—Ä–∞ –∫—Ä–∞—Å–Ω–∞—è": 0.5,
  "–ú–æ—Ä—Ç–∞–¥–µ–ª–ª–∞": 0.5,
  "–ß—É–∫–∞": 0.5,
  "–ú–æ–ª–æ–∫–æ 2,5%": 12,
  "–°–ª–∏–≤–∫–∏ 23%": 12,
  "–°–º–µ—Ç–∞–Ω–∞": 12,
  "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ": 5,
  "–ú–∞–π–æ–Ω–µ–∑": 5,
  "–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ": 15,
  "–ú–∞—Å–ª–æ —Ñ—Ä–∏—Ç—é—Ä–Ω–æ–µ": 15,
  "–û–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ": 8,
  "–ú–∞–∫–∞—Ä–æ–Ω—ã —à—Ç–∞—Ç": 5,
  "–¢–æ–±–∏–∫–∞": 0.5,
  "–í–æ–¥–æ—Ä–æ—Å–ª–∏ –•–∏—è—à–∏": 0.5,
  "–Ø–±–ª–æ—á–Ω—ã–π –ø–µ–∫—Ç–∏–Ω": 0.1,
  "–¢—ã–∫–≤–∞ —Å/–º": 2.5,
  "–®–∞–º–ø–∏–Ω—å–æ–Ω—ã —Å/–º": 2.5,
  "–í–∏—à–Ω—è —Å/–º": 2.5,
  "–õ–∞–≤–∞—à –∫—Ä—É–≥–ª—ã–π": 20,
  "–ì—Ä–∏–± –±–µ–ª—ã–π —Å—É—Ö–æ–π": 0.2,
  "–ì–æ—Ä–æ—à–µ–∫ —Å/–º": 2.5
};

function update(product, delta) {
    if (locked[product]) return;
    locked[product] = true;

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–≥
    const step = productStep[product] || 1;
    if (!(product in order)) order[product] = 0;

    let newValue = order[product] + delta * step;
    if (newValue < 0) newValue = 0;
    newValue = Math.round(newValue * 100) / 100;

    if (newValue !== order[product]) {
        order[product] = newValue;

        // üîÅ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã
        document.querySelectorAll(`[id='${CSS.escape(product)}']`).forEach(el => {
            el.innerText = newValue;
        });

        saveOrder();
    }

    locked[product] = false;
}
function saveOrder() {
    localStorage.setItem("beermanOrder", JSON.stringify(order));
}
function loadOrder() {
    const saved = localStorage.getItem("beermanOrder");
    if (saved) {
        order = JSON.parse(saved);

        // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
        for (const product in order) {
            document.querySelectorAll(`[id='${CSS.escape(product)}']`).forEach(el => {
                el.innerText = order[product];
            });
        }
    }
}
const BOT_TOKEN = "8416977089:AAG49nmrwX1RuCSxJL3zlqaTgeLLa8jgs3Y";

function sendOrderToTelegram(orderText) {
    const user = Telegram.WebApp.initDataUnsafe.user;
    let chatId = user.id;

    // üî• —Ç—É—Ç –¥–æ–±–∞–≤–ª—è–µ–º return
    return fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            chat_id:  chatId,
            text: orderText
        })
    })
        .then(res => res.json());
}

function sendOrder() {
    const user = Telegram.WebApp.initDataUnsafe.user; // –¥–æ–±–∞–≤–∏–ª–∏
    let items = [];

    if (user.username === "ellieene" || user.id === 1293255597 || user.username === "Kalashik_1989" || user.id === 992762908) {
        items.push(`–ï–¥–∏–º –≤–º–µ—Å—Ç–µ(–ë2) \n–ö–∞–º–µ–Ω—Å–∫–∞ 7\n\n`);
    } else if (user.id === 1596541382 || user.id === 1092288702) {
        items.push(`–í–æ–∫–∑–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å(–ë1) \n–í–æ–∫–∑–∞–ª—å–Ω–∞—è –º–∞–≥–∏—Å—Ç—Ä–∞–ª—å 1\n\n`);
    } else if (user.id === 1001983598) {
        items.push(`–†–∏–≤–µ—Ä –ø–ª–µ–π—Å(–ë4) \n–î–æ–±—Ä–æ–ª—é–±–æ–≤–∞ 2–∞\n\n`);
    }

    for (const category in catalogData) {
        catalogData[category].forEach(product => {
            if (order[product.name] > 0) {
                items.push(`${product.name} - ${order[product.name]} ${product.unit.replace(/\d+[.,]?\d*/g, "").trim()}`);
            }
        });
    }

    if (items.length === 0) {
        alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!");
        return;
    }

    let message = items.join("\n");
    sendOrderToTelegram(message)
        .then(data => {
            console.log("‚úÖ –£—Å–ø–µ—Ö:", data);
            localStorage.removeItem("beermanOrder");
            Telegram.WebApp.close();
        })
        .catch(err => {
            console.error("üö® –û—à–∏–±–∫–∞:", err);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ üö®");
        });
}

// --- üîç –ü–æ–∏—Å–∫ ---
function toggleSearch() {
    const box = document.getElementById("search-box");
    box.style.display = box.style.display === "none" ? "block" : "none";
    document.getElementById("search-input").focus();
}

document.getElementById("search-input").addEventListener("input", function() {
    const query = this.value.trim().toLowerCase();
    const results = document.querySelector(".search-results");
    results.innerHTML = "";

    if (!query) return;

    for (const category in catalogData) {
        catalogData[category].forEach(product => {
            if (product.name.toLowerCase().includes(query)) {
                const div = document.createElement("div");
                div.textContent = `${product.name} (${product.unit})`;
                div.onclick = () => {
                    toggleSearch();
                    scrollToProduct(product.name);
                };
                results.appendChild(div);
            }
        });
    }

    if (!results.innerHTML) {
        results.innerHTML = "<div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>";
    }
});

function scrollToProduct(name) {
    const el = document.getElementById(name);
    if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "center" });

        // üî¶ –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
        const productBlock = el.closest(".product");
        if (productBlock) {
            productBlock.classList.add("highlighted");
            setTimeout(() => {
                productBlock.classList.remove("highlighted");
            }, 2000);
        }
    }
}

async function renderCatalog() {
  const response = await fetch('catalog.json');
  catalogData = await response.json();

  const user = Telegram.WebApp.initDataUnsafe.user;
  const container = document.getElementById("catalog");
  const adminPanel = document.getElementById("admin-panel");
  if (user && user.username === "ellieen") {
      container.style.display = "none";
      document.querySelector(".send-btn").style.display = "none";
      adminPanel.style.display = "block";

      renderAdminCategories();
      renderAdminProducts();
  } else if (user && (user.username === "ellieene" || user.id === 1293255597 || user.id === 1596541382 || user.id === 1092288702 || user.id === 1001983598 || user.username === "Kalashik_1989" || user.id === 992762908)) {
      adminPanel.style.display = "none";
      container.style.display = "block";
      document.querySelector(".send-btn").style.display = "block";

      container.innerHTML = "";
      for (const category in catalogData) {
          const h2 = document.createElement("h2");
          h2.textContent = category;
          container.appendChild(h2);

          catalogData[category].forEach(product => {
              const div = document.createElement("div");
              div.className = "product";

              const nameSpan = document.createElement("span");
              nameSpan.className = "name";
              nameSpan.textContent = `${product.name} (${product.unit})`;

              const btns = document.createElement("div");
              btns.className = "btns";

              const minus = document.createElement("button");
              minus.textContent = "-";
              minus.onclick = () => update(product.name, -1);

              const count = document.createElement("span");
              count.id = product.name;
              count.textContent = "0";

              const plus = document.createElement("button");
              plus.textContent = "+";
              plus.onclick = () => update(product.name, 1);

              btns.appendChild(minus);
              btns.appendChild(count);
              btns.appendChild(plus);

              div.appendChild(nameSpan);
              div.appendChild(btns);

              container.appendChild(div);
          });
      }
  } else {
      const container = document.getElementById("catalog");
      container.style.display = "block";
      document.querySelector(".send-btn").style.display = "none";
      adminPanel.style.display = "none";

      container.innerHTML = ""; // –æ—á–∏—â–∞–µ–º
      const img = document.createElement("img");
      img.src = "https://img-webcalypt.ru/img/thumb/lg/images/meme-templates/cDQV4DzT8v2N1ANOOZSOTO5vb3ElmkRp.jpg.jpg";
      img.alt = "–û–±–µ–∑—å—è–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∂–µ—Å—Ç";
      img.width = 350;
      img.height = 280;

      container.appendChild(img);
  }
}

// --- –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏ ---
function renderAdminCategories() {
  const catSelect = document.getElementById("admin-category");
  catSelect.innerHTML = "";
  for (const category in catalogData) {
    const opt = document.createElement("option");
    opt.value = category;
    opt.textContent = category;
    catSelect.appendChild(opt);
  }
}

function renderAdminProducts() {
  const div = document.getElementById("admin-products");
  div.innerHTML = "";
  for (const category in catalogData) {
    catalogData[category].forEach(product => {
      const pDiv = document.createElement("div");
      pDiv.textContent = `${category} ‚Üí ${product.name} (${product.unit})`;
      const delBtn = document.createElement("button");
      delBtn.textContent = "‚ùå";
      delBtn.className = "remove-btn";
      delBtn.onclick = () => {
        catalogData[category] = catalogData[category].filter(p => p.name !== product.name);
        renderAdminProducts();
        renderAdminCategories();
      };
      pDiv.appendChild(delBtn);
      div.appendChild(pDiv);
    });
  }
}

function addCategory() {
  const name = document.getElementById("new-category").value.trim();
  if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
  if (!catalogData[name]) catalogData[name] = [];
  renderAdminCategories();
  document.getElementById("new-category").value = "";
}

function addProduct() {
  const name = document.getElementById("admin-name").value.trim();
  const category = document.getElementById("admin-category").value;
  const unit = document.getElementById("admin-unit").value;
  if (!name || !category) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");

  if (!catalogData[category]) catalogData[category] = [];
  catalogData[category].push({ name, unit });

  renderAdminProducts();
  renderAdminCategories();
  document.getElementById("admin-name").value = "";
}
window.onload = async () => {
    await renderCatalog();
    loadOrder();  // ‚úÖ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
};
</script>
</body>
</html>
