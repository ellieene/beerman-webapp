<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Beerman –ó–∞–∫–∞–∑—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; background: #f5f5f5; margin: 0; padding: 10px; }
    #beerman { color:#e74c3c; text-align:center; font-size:26px; margin-bottom:20px; }
    h1 { text-align: center; font-size: 24px; }
    h2 { margin-top: 20px; font-size: 20px; }
    .product { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px 10px; margin: 5px 0; border-radius: 8px; font-size: 18px; }
    .product span.name { flex: 1 1 auto; min-width: 120px; margin-right: 10px; word-break: break-word; }
    .btns { display: flex; align-items: center; gap: 10px; flex: 0 0 auto; }
    .btns button { width: 45px; height: 45px; font-size: 22px; border-radius: 8px; border: none; background: #007bff; color: white; cursor:pointer; }
    .btns span { min-width: 30px; text-align: center; font-size: 18px; display: inline-block; }
    .send-btn { display: block; width: 100%; padding: 15px 0; font-size: 20px; background: #28a745; color: white; border: none; border-radius: 8px; margin-top: 30px; cursor:pointer; }
    
    /* –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å */
    #admin-panel { display:none; margin-top:30px; padding:20px; background:#ffffff; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    #admin-panel h2 { color:#e74c3c; text-align:center; font-size:26px; margin-bottom:20px; }
    #admin-panel input, #admin-panel select { padding:5px; margin-left:5px; border-radius:6px; border:1px solid #ccc; }
    #admin-panel button { cursor:pointer; border:none; border-radius:6px; padding:5px 10px; }
    .add-cat-btn { background:#27ae60; color:white; }
    .add-prod-btn { background:#3498db; color:white; }
    .remove-btn { background:#dc3545; color:white; margin-left:10px; }
    #admin-products div { background:#f8f9fa; padding:5px 10px; border-radius:6px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <h2 id="beerman">BEERMAN</h2>
  <div id="catalog"></div>
  <button class="send-btn" onclick="sendOrder()">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>

  <!-- –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
  <div id="admin-panel">
      <h2>üõ†Ô∏è BEERMAN ‚ö°</h2>

      <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
        <label style="flex:1;">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:
          <select id="admin-category"></select>
        </label>
        <input type="text" id="new-category" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="flex:1;">
        <button onclick="addCategory()" class="add-cat-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div style="margin-bottom:15px; display:flex; align-items:center; gap:10px;">
        <input type="text" id="admin-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" style="flex:2;">
        <select id="admin-unit" style="flex:1;">
          <option value="—à—Ç">—à—Ç</option>
          <option value="–∫–≥">–∫–≥</option>
          <option value="–ª">–ª</option>
        </select>
        <button onclick="addProduct()" class="add-prod-btn">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <h3 style="color:#2c3e50; font-size:20px; margin-bottom:10px;">–¢–æ–≤–∞—Ä—ã üìù</h3>
      <div id="admin-products"></div>
  </div>

<script>
let order = {};
let catalogData = {};
let locked = {};
const productStep = {
  "–ò–∫—Ä–∞ –∫—Ä–∞—Å–Ω–∞—è": 0.5,
  "–ú–æ—Ä—Ç–∞–¥–µ–ª–ª–∞": 0.5,
  "–ß—É–∫–∞": 0.5,
  "–ú–æ–ª–æ–∫–æ 2,5%": 12,
  "–°–ª–∏–≤–∫–∏ 23%": 12,
  "–°–º–µ—Ç–∞–Ω–∞": 12,
  "–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ": 5,
  "–ú–∞–π–æ–Ω–µ–∑": 5,
  "–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ": 15,
  "–ú–∞—Å–ª–æ —Ñ—Ä–∏—Ç—é—Ä–Ω–æ–µ": 15,
  "–û–≥—É—Ä—Ü—ã –º–∞—Ä–∏–Ω–æ–≤–∞–Ω–Ω—ã–µ": 8,
  "–ú–∞–∫–∞—Ä–æ–Ω—ã —à—Ç–∞—Ç": 5,
  "–¢–æ–±–∏–∫–∞": 0.5
};

function update(product, delta) {
  if (locked[product]) return;
  locked[product] = true;

  if (!(product in order)) order[product] = 0;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —à–∞–≥
  const step = productStep[product] || 1;

  let newValue = order[product] + delta * step;
  if (newValue < 0) newValue = 0;

  // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π, —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–æ—Å—å
  newValue = Math.round(newValue * 100) / 100;

  if (newValue !== order[product]) {
    order[product] = newValue;
    document.getElementById(product).innerText = order[product];
    saveOrder();   // ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
  }

  locked[product] = false;
}
function saveOrder() {
    localStorage.setItem("beermanOrder", JSON.stringify(order));
}
function loadOrder() {
    const saved = localStorage.getItem("beermanOrder");
    if (saved) {
        order = JSON.parse(saved);

        // –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è
        for (const product in order) {
            const el = document.getElementById(product);
            if (el) el.innerText = order[product];
        }
    }
}
const BOT_TOKEN = "8416977089:AAG49nmrwX1RuCSxJL3zlqaTgeLLa8jgs3Y";

function sendOrderToTelegram(orderText) {
  const user = Telegram.WebApp.initDataUnsafe.user;
  let chatId;

  if (user.username === "ellieene") {
      chatId = "743849466";
  } else if (user.username === "Aleksei_Aleksandrovich1") {
      chatId = "380680905";
  } else {
      console.error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
      return Promise.reject("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å");
    }
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            chat_id:  chatId,
            text: orderText
        })
    })
    .then(res => res.json())
    .then(data => console.log("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:", data))
    .catch(err => console.error(err));
}

function sendOrder() {
  let items = [];
  items.push(`–ï–¥–∏–º –≤–º–µ—Å—Ç–µ(–ë2) \n–ö–∞–º–µ–Ω—Å–∫–∞ 7\n\n`);

  for (const category in catalogData) {
    catalogData[category].forEach(product => {
      if (order[product.name] > 0) {
        items.push(`${product.name} - ${order[product.name]}${product.unit}`);
      }
    });
  }

  if (items.length === 0) { 
    alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞!"); 
    return; 
  }

  let message = items.join("\n");
  sendOrderToTelegram(message)
    .then(() => {
      localStorage.removeItem("beermanOrder");
      Telegram.WebApp.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
    })
    .catch(() => {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ üö®");
    });

}

async function renderCatalog() {
  const response = await fetch('catalog.json');
  catalogData = await response.json();

  const user = Telegram.WebApp.initDataUnsafe.user;
  const container = document.getElementById("catalog");
  const adminPanel = document.getElementById("admin-panel");

  if (user && user.username === "ellieen") {
    container.style.display = "none";
    document.querySelector(".send-btn").style.display = "none";
    adminPanel.style.display = "block";

    renderAdminCategories();
    renderAdminProducts();
  } else if (user.username === "ellieene" || user.username === "Aleksei_Aleksandrovich1") {
    adminPanel.style.display = "none";
    container.style.display = "block";
    document.querySelector(".send-btn").style.display = "block";

    container.innerHTML = "";
    for (const category in catalogData) {
      const h2 = document.createElement("h2");
      h2.textContent = category;
      container.appendChild(h2);

      catalogData[category].forEach(product => {
        const div = document.createElement("div");
        div.className = "product";

        const nameSpan = document.createElement("span");
        nameSpan.className = "name";
        nameSpan.textContent = `${product.name} (${product.unit})`;

        const btns = document.createElement("div");
        btns.className = "btns";

        const minus = document.createElement("button");
        minus.textContent = "-";
        minus.onclick = () => update(product.name, -1);

        const count = document.createElement("span");
        count.id = product.name;
        count.textContent = "0";

        const plus = document.createElement("button");
        plus.textContent = "+";
        plus.onclick = () => update(product.name, 1);

        btns.appendChild(minus);
        btns.appendChild(count);
        btns.appendChild(plus);

        div.appendChild(nameSpan);
        div.appendChild(btns);

        container.appendChild(div);
      });
    }
  }
}

// --- –ê–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–∏ ---
function renderAdminCategories() {
  const catSelect = document.getElementById("admin-category");
  catSelect.innerHTML = "";
  for (const category in catalogData) {
    const opt = document.createElement("option");
    opt.value = category;
    opt.textContent = category;
    catSelect.appendChild(opt);
  }
}

function renderAdminProducts() {
  const div = document.getElementById("admin-products");
  div.innerHTML = "";
  for (const category in catalogData) {
    catalogData[category].forEach(product => {
      const pDiv = document.createElement("div");
      pDiv.textContent = `${category} ‚Üí ${product.name} (${product.unit})`;
      const delBtn = document.createElement("button");
      delBtn.textContent = "‚ùå";
      delBtn.className = "remove-btn";
      delBtn.onclick = () => {
        catalogData[category] = catalogData[category].filter(p => p.name !== product.name);
        renderAdminProducts();
        renderAdminCategories();
      };
      pDiv.appendChild(delBtn);
      div.appendChild(pDiv);
    });
  }
}

function addCategory() {
  const name = document.getElementById("new-category").value.trim();
  if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏");
  if (!catalogData[name]) catalogData[name] = [];
  renderAdminCategories();
  document.getElementById("new-category").value = "";
}

function addProduct() {
  const name = document.getElementById("admin-name").value.trim();
  const category = document.getElementById("admin-category").value;
  const unit = document.getElementById("admin-unit").value;
  if (!name || !category) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é");

  if (!catalogData[category]) catalogData[category] = [];
  catalogData[category].push({ name, unit });

  renderAdminProducts();
  renderAdminCategories();
  document.getElementById("admin-name").value = "";
}
window.onload = async () => {
    await renderCatalog();
    loadOrder();  // ‚úÖ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
};
</script>
</body>
</html>